В общем решение выглядит нормальным, единственное нужно добавить константы для режимов работы